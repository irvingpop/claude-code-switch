#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
CCM_CMD_DEFAULT="$SCRIPT_DIR/ccm.sh"
CCM="${CCM_CMD:-$CCM_CMD_DEFAULT}"

usage() {
    cat <<EOF
Usage: ./ccc <model> [claude-options]
       ./ccc <account> [claude-options]
       ./ccc <model>:<account> [claude-options]
       ./ccc oauth:<profile> [claude-options]
       ./ccc <model>:oauth:<profile> [claude-options]

Examples:
  ./ccc sonnet                          # Launch Claude Code with Sonnet
  ./ccc opus --dangerously-skip-permissions  # Pass options to Claude Code
  ./ccc work                            # Switch to 'work' account and launch
  ./ccc opus:work                       # Switch to 'work' account and use Opus

OAuth Examples:
  ./ccc oauth:personal                  # Switch to OAuth profile 'personal'
  ./ccc opus:oauth:work                 # Switch to OAuth 'work' with Opus

Available models:
  sonnet, s           Claude Sonnet 4.5 (default)
  opus, o             Claude Opus 4.5
  haiku, h            Claude Haiku 4.5
  <account>           Switch to saved account and use default model
  <model>:<account>   Switch to saved account and use specified model
  oauth:<profile>     Switch to OAuth profile and launch
  <model>:oauth:<profile>  Switch to OAuth profile with specified model
EOF
}

if [[ ! -f "$CCM" ]]; then
    echo "ccc error: cannot find ccm CLI at $CCM" >&2
    echo "Hint: ensure ccm.sh exists next to this script, or set CCM_CMD=/path/to/ccm.sh" >&2
    exit 1
fi

if [[ $# -lt 1 ]]; then
    usage
    exit 1
fi

model="$1"
shift || true

claude_args=("$@")

is_known_model() {
    case "$1" in
        claude|sonnet|s|opus|o|haiku|h)
            return 0 ;;
        *)
            return 1 ;;
    esac
}

switch_model() {
    local model_name="$1"
    case "$model_name" in
        ""|claude|sonnet|s)
            source <("$CCM" sonnet)
            ;;
        opus|o)
            source <("$CCM" opus)
            ;;
        haiku|h)
            source <("$CCM" haiku)
            ;;
        *)
            echo "Error: Unknown model: $model_name" >&2
            exit 1
            ;;
    esac
}

if [[ "$model" == oauth:* ]]; then
    oauth_profile="${model#oauth:}"
    if ! "$CCM" oauth-switch "$oauth_profile"; then
        echo "Error: Failed to switch OAuth profile: $oauth_profile" >&2
        exit 1
    fi
    switch_model "sonnet"
elif [[ "$model" == *:oauth:* ]]; then
    IFS=':' read -r model_part _ oauth_profile <<< "$model"
    if ! "$CCM" oauth-switch "$oauth_profile"; then
        echo "Error: Failed to switch OAuth profile: $oauth_profile" >&2
        exit 1
    fi
    switch_model "$model_part"
elif [[ "$model" != *:* ]] && ! is_known_model "$model" && [[ ! "$model" =~ ^- ]]; then
    account="$model"
    if ! "$CCM" switch-account "$account"; then
        echo "Error: Failed to switch account: $account" >&2
        exit 1
    fi
    "$CCM" current-account || true
    switch_model "sonnet"
elif [[ "$model" == *:* ]]; then
    IFS=':' read -r model_part account_part <<< "$model"

    if ! "$CCM" switch-account "$account_part"; then
        echo "Error: Failed to switch account: $account_part" >&2
        exit 1
    fi
    switch_model "$model_part"
else
    switch_model "$model"
fi

echo ""
echo ">> Launching Claude Code..."
echo "   Model: ${ANTHROPIC_MODEL:-'(unset)'}"
if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
    echo "   OAuth: Set"
elif [[ -n "${ANTHROPIC_AUTH_TOKEN:-}" ]]; then
    echo "   Token: Set"
fi

if ! command -v claude >/dev/null 2>&1; then
    echo "Error: 'claude' CLI not found. Install it first: npm install -g @anthropic-ai/claude-code" >&2
    exit 127
fi

if [[ ${#claude_args[@]} -eq 0 ]]; then
    exec claude
else
    exec claude "${claude_args[@]}"
fi
