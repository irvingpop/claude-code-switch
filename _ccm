#compdef ccm

_ccm_accounts() {
  local accounts
  if [[ -f ~/.ccm_accounts ]]; then
    accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
    _describe 'account' accounts
  fi
}

_ccm() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  _arguments -C \
    '1: :->command' \
    '2: :->argument' \
    '3: :->argument'

  case $state in
    command)
      local -a commands
      commands=(
        'sonnet:Switch to Claude Sonnet 4.5'
        's:Switch to Claude Sonnet 4.5 (alias)'
        'opus:Switch to Claude Opus 4.5'
        'o:Switch to Claude Opus 4.5 (alias)'
        'haiku:Switch to Claude Haiku 4.5'
        'h:Switch to Claude Haiku 4.5 (alias)'
        'save-account:Save current token as named account (use --oauth for OAuth)'
        'switch-account:Switch to a saved account (auto-detects type)'
        'list-accounts:List all saved accounts (shows API and OAuth)'
        'delete-account:Delete a saved account (handles both types)'
        'current-account:Show currently active account with type'
        'status:Show current configuration'
        'st:Show current configuration (alias)'
        'help:Show help message'
      )
      _describe 'command' commands
      ;;
    argument)
      case ${words[2]} in
        save-account)
          # Offer --oauth flag or account name
          if [[ ${words[3]} == "" ]]; then
            local -a opts
            opts=(
              '--oauth:Create OAuth account (runs claude setup-token)'
            )
            _describe 'option or account' opts
            _ccm_accounts
          else
            _ccm_accounts
          fi
          ;;
        switch-account|delete-account)
          _ccm_accounts
          ;;
        sonnet|s|opus|o|haiku|h)
          _ccm_accounts
          ;;
      esac
      ;;
  esac
}

_ccm "$@"
