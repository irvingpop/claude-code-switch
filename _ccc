#compdef ccc

_ccc_accounts() {
  local accounts
  if [[ -f ~/.ccm_accounts ]]; then
    accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
    _describe 'account' accounts
  fi
}

_ccc() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  _arguments -C \
    '1: :->model_or_account' \
    '*::arg:->args'

  case $state in
    model_or_account)
      local -a models accounts combined
      models=(
        'sonnet:Claude Sonnet 4.5'
        's:Claude Sonnet 4.5 (alias)'
        'opus:Claude Opus 4.5'
        'o:Claude Opus 4.5 (alias)'
        'haiku:Claude Haiku 4.5'
        'h:Claude Haiku 4.5 (alias)'
      )

      # Check if we're completing after "model:"
      if [[ "$words[CURRENT]" == sonnet:* || "$words[CURRENT]" == s:* || \
            "$words[CURRENT]" == opus:* || "$words[CURRENT]" == o:* || \
            "$words[CURRENT]" == haiku:* || "$words[CURRENT]" == h:* ]]; then
        local model_part="${words[CURRENT]%%:*}"
        local -a model_completions

        # Add accounts (both API and OAuth)
        if [[ -f ~/.ccm_accounts ]]; then
          accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
          for acc in $accounts; do
            model_completions+=("${model_part}:${acc}:${model_part} with account '${acc}' (auto-detects type)")
          done
        fi

        _describe 'model with account' model_completions
        return
      fi

      # Default: show models and all accounts (API and OAuth)
      combined=($models)

      if [[ -f ~/.ccm_accounts ]]; then
        accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
        for acc in $accounts; do
          combined+=("$acc:Switch to account '$acc' (auto-detects type)")
        done
      fi

      _describe 'model or account' combined
      ;;
    args)
      _arguments '*: :_files'
      ;;
  esac
}

_ccc "$@"
