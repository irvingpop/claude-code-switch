#compdef ccc

_ccc_accounts() {
  local accounts
  if [[ -f ~/.ccm_accounts ]]; then
    accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
    _describe 'account' accounts
  fi
}

_ccc_oauth_profiles() {
  local profiles
  local oauth_dir="${HOME}/.ccm/oauth"
  if [[ -d "$oauth_dir" ]]; then
    profiles=(${(f)"$(ls "$oauth_dir"/*.token 2>/dev/null | xargs -n1 basename | sed 's/\.token$//')"})
    _describe 'oauth-profile' profiles
  fi
}

_ccc() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  _arguments -C \
    '1: :->model_or_account' \
    '*::arg:->args'

  case $state in
    model_or_account)
      local -a models accounts oauth_profiles combined model_oauth model_accounts
      models=(
        'sonnet:Claude Sonnet 4.5'
        's:Claude Sonnet 4.5 (alias)'
        'opus:Claude Opus 4.5'
        'o:Claude Opus 4.5 (alias)'
        'haiku:Claude Haiku 4.5'
        'h:Claude Haiku 4.5 (alias)'
      )

      # Check if we're completing after "oauth:"
      if [[ "$words[CURRENT]" == oauth:* ]]; then
        local prefix="oauth:"
        local oauth_dir="${HOME}/.ccm/oauth"
        if [[ -d "$oauth_dir" ]]; then
          oauth_profiles=(${(f)"$(ls "$oauth_dir"/*.token 2>/dev/null | xargs -n1 basename | sed 's/\.token$//')"})
          local -a oauth_completions
          for prof in $oauth_profiles; do
            oauth_completions+=("oauth:${prof}:Switch to OAuth profile '${prof}'")
          done
          _describe 'oauth profile' oauth_completions
        fi
        return
      fi

      # Check if we're completing after "model:oauth:"
      if [[ "$words[CURRENT]" == *:oauth:* ]]; then
        local model_part="${words[CURRENT]%%:oauth:*}"
        local oauth_dir="${HOME}/.ccm/oauth"
        if [[ -d "$oauth_dir" ]]; then
          oauth_profiles=(${(f)"$(ls "$oauth_dir"/*.token 2>/dev/null | xargs -n1 basename | sed 's/\.token$//')"})
          local -a oauth_completions
          for prof in $oauth_profiles; do
            oauth_completions+=("${model_part}:oauth:${prof}:${model_part} model with OAuth profile '${prof}'")
          done
          _describe 'model with oauth profile' oauth_completions
        fi
        return
      fi

      # Check if we're completing after "model:"
      if [[ "$words[CURRENT]" == sonnet:* || "$words[CURRENT]" == s:* || \
            "$words[CURRENT]" == opus:* || "$words[CURRENT]" == o:* || \
            "$words[CURRENT]" == haiku:* || "$words[CURRENT]" == h:* ]]; then
        local model_part="${words[CURRENT]%%:*}"
        local -a model_completions

        # Add accounts
        if [[ -f ~/.ccm_accounts ]]; then
          accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
          for acc in $accounts; do
            model_completions+=("${model_part}:${acc}:${model_part} with account '${acc}'")
          done
        fi

        # Add oauth: prefix
        model_completions+=("${model_part}:oauth\::${model_part} with OAuth profile")

        _describe 'model with account or oauth' model_completions
        return
      fi

      # Default: show models, accounts, and oauth: prefix
      combined=($models)

      if [[ -f ~/.ccm_accounts ]]; then
        accounts=(${(f)"$(cut -d'|' -f1 ~/.ccm_accounts 2>/dev/null)"})
        for acc in $accounts; do
          combined+=("$acc:Switch to account '$acc'")
        done
      fi

      # Add oauth: prefix
      combined+=('oauth\::Switch to OAuth profile')

      _describe 'model, account, or oauth' combined
      ;;
    args)
      _arguments '*: :_files'
      ;;
  esac
}

_ccc "$@"
